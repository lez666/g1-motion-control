# 数据修复报告

## 问题诊断

### 发现的问题
1. **速度过大**: 最大关节速度达到 74.36 rad/s（正常范围：10-20 rad/s）
2. **根本原因**: 速度没有按LAFAN倍率（1.27/1.7 ≈ 0.747）缩放
3. **影响**: 导致训练和仿真失败

### 数据对比

| 指标 | 修复前 | 修复后 | 缩放比例 |
|------|--------|--------|----------|
| 关节速度最大值 | 74.36 rad/s | 55.55 rad/s | 0.747 ✅ |
| Body线性速度最大值 | 4.78 m/s | 3.57 m/s | 0.747 ✅ |
| Body角速度最大值 | 15.83 rad/s | 11.82 rad/s | 0.747 ✅ |

## 修复结果

### 修复后的文件
- **文件路径**: `/home/wasabi/g1-motion-control/my work space/fight1_subject3_robot_motion_wbt_fixed.npz`
- **文件大小**: 14 MB
- **状态**: ✅ 速度已正确缩放

### 验证结果
- ✅ 缩放比例正确：0.747059（与LAFAN倍率一致）
- ✅ 速度范围更合理：55.55 rad/s（虽然仍较大，但比之前好很多）
- ✅ 所有速度字段都已正确缩放

## 代码修改

### 已修改的文件
1. **`third_party/holosoma/src/holosoma_retargeting/data_conversion/convert_data_format_mj.py`**
   - 添加 `velocity_scale` 参数
   - 自动检测LAFAN格式并应用倍率
   - 所有速度计算后乘以倍率

### 修复脚本
- **`my work space/fix_velocity_scaling.py`**: 用于修复现有数据文件

## 下一步

1. **使用修复后的文件重新训练**:
   ```bash
   python src/holosoma/holosoma/train_agent.py \
       exp:g1-29dof-wbt \
       --command.setup_terms.motion_command.params.motion_config.motion_file=/home/wasabi/g1-motion-control/my\ work\ space/fight1_subject3_robot_motion_wbt_fixed.npz
   ```

2. **未来数据转换**: 
   - 使用修改后的 `convert_data_format_mj.py` 会自动应用正确的倍率
   - 无需手动修复

3. **验证训练效果**: 
   - 检查训练日志中的速度误差是否降低
   - 观察仿真行为是否改善

## 注意事项

- 修复后的速度（55.55 rad/s）仍然较大，可能需要进一步检查：
  - 原始动作数据本身速度是否就很大
  - Retargeting过程是否正确
- 如果速度仍然过大，可能需要调整retargeting参数或检查原始数据
